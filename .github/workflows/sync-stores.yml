name: Sync Dev to Stage with JSON Protection

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - store-stage

jobs:
  exclude-json-from-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify PR is from store-dev
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          
          if [ "$BASE_BRANCH" != "store-stage" ] || [ "$HEAD_BRANCH" != "store-dev" ]; then
            echo "â­ï¸  This workflow only processes PRs from store-dev to store-stage"
            exit 0
          fi

      - name: Set Git Identity
        run: |
          git config user.name "Store Sync Bot"
          git config user.email "bot@yourstore.com"

      - name: Check and Revert JSON Files
        id: revert_json
        run: |
          # Fetch the base branch (store-stage)
          git fetch origin store-stage

          # Find all JSON files that differ from store-stage
          JSON_FILES=$(git diff --name-only origin/store-stage...HEAD | grep '\.json$' || true)

          if [ -z "$JSON_FILES" ]; then
            echo "âœ… No JSON files changed in this PR"
            echo "has_json_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found JSON file changes that will be reverted:"
          echo "$JSON_FILES"
          echo "$JSON_FILES" > /tmp/json_files.txt

          # Revert all JSON files to store-stage version
          echo "$JSON_FILES" | while IFS= read -r file; do
            if git show origin/store-stage:"$file" > /dev/null 2>&1; then
              echo "Reverting $file to store-stage version"
              git checkout origin/store-stage -- "$file"
            else
              echo "Removing new JSON file: $file"
              git rm "$file"
            fi
          done

          # Check if there are changes to commit
          if ! git diff --cached --quiet || ! git diff --quiet; then
            git add -A
            git commit -m "ðŸ¤– Auto-revert JSON files to store-stage version

JSON files are automatically excluded from store-stage merges to prevent Shopify config conflicts.

Reverted/removed files:
$JSON_FILES"
            git push origin ${{ github.event.pull_request.head.ref }}
            echo "has_json_changes=true" >> $GITHUB_OUTPUT
            echo "json_files<<EOF" >> $GITHUB_OUTPUT
            echo "$JSON_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "âœ… JSON files already match store-stage"
            echo "has_json_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: steps.revert_json.outputs.has_json_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const jsonFiles = `${{ steps.revert_json.outputs.json_files }}`;
            const body = `ðŸ”’ **JSON Files Auto-Excluded**

The following JSON files have been automatically reverted to match \`store-stage\`:

\`\`\`
${jsonFiles}
\`\`\`

**Why?** JSON files contain Shopify store configurations that should not be synced between environments. Only code changes (Liquid templates, CSS, JS) are merged to \`store-stage\`.

âœ… Your PR now contains only non-JSON changes and is ready for review.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
