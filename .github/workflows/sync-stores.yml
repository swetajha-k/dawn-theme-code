name: Sync Dev to Stage with JSON Protection

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - store-stage

jobs:
  exclude-json-from-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Verify PR is from store-dev
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_STATE="${{ github.event.pull_request.state }}"

          echo "PR State: $PR_STATE"
          echo "Base: $BASE_BRANCH â†’ Head: $HEAD_BRANCH"

          if [ "$PR_STATE" != "open" ]; then
            echo "â­ï¸  PR is not open, skipping"
            exit 0
          fi

          if [ "$BASE_BRANCH" != "store-stage" ] || [ "$HEAD_BRANCH" != "store-dev" ]; then
            echo "â­ï¸  This workflow only processes PRs from store-dev to store-stage"
            exit 0
          fi

          echo "âœ… PR verified: store-dev â†’ store-stage"

      - name: Set Git Identity
        run: |
          git config user.name "Store Sync Bot"
          git config user.email "bot@yourstore.com"

      - name: Check and Revert JSON Files
        id: revert_json
        run: |
          set -e  # Exit on error

          echo "Current branch: $(git branch --show-current)"
          echo "Current commit: $(git rev-parse HEAD)"

          # Fetch the base branch (store-stage)
          git fetch origin store-stage
          echo "Fetched store-stage: $(git rev-parse origin/store-stage)"

          # Find all JSON files that differ from store-stage
          JSON_FILES=$(git diff --name-only origin/store-stage...HEAD | grep '\.json$' || true)

          if [ -z "$JSON_FILES" ]; then
            echo "âœ… No JSON files changed in this PR"
            echo "has_json_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found JSON file changes that will be reverted:"
          echo "$JSON_FILES"

          # Store the list for later use
          JSON_LIST=""

          # Revert all JSON files to store-stage version
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              JSON_LIST="${JSON_LIST}${file}\n"
              if git show origin/store-stage:"$file" > /dev/null 2>&1; then
                echo "Reverting $file to store-stage version"
                git checkout origin/store-stage -- "$file"
              else
                echo "Removing new JSON file: $file (doesn't exist in store-stage)"
                git rm -f "$file" || true
              fi
            fi
          done <<< "$JSON_FILES"

          # Stage all changes
          git add -A

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "âœ… JSON files already match store-stage"
            echo "has_json_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Committing changes..."
          COMMIT_MSG="Auto-revert JSON files to store-stage version

JSON files are automatically excluded from store-stage merges to prevent Shopify config conflicts.

Reverted/removed files:
$JSON_FILES"
          git commit -m "$COMMIT_MSG"

          echo "Pushing to branch: ${{ github.event.pull_request.head.ref }}"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}

          echo "has_json_changes=true" >> $GITHUB_OUTPUT
          echo "json_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$JSON_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "âœ… Successfully reverted JSON files"

      - name: Comment on PR
        if: steps.revert_json.outputs.has_json_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const jsonFiles = `${{ steps.revert_json.outputs.json_files }}`;
            const body = `ðŸ”’ **JSON Files Auto-Excluded**

The following JSON files have been automatically reverted to match \`store-stage\`:

\`\`\`
${jsonFiles}
\`\`\`

**Why?** JSON files contain Shopify store configurations that should not be synced between environments. Only code changes (Liquid templates, CSS, JS) are merged to \`store-stage\`.

âœ… Your PR now contains only non-JSON changes and is ready for review.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
