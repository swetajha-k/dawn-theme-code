name: Sync Dev to Stage with JSON Protection

on:
  workflow_dispatch:  # Manual trigger for sync
  pull_request:
    branches:
      - store-stage  # Automatic protection on PRs

jobs:
  merge-to-stage:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for merging
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Git Identity
        run: |
          git config user.name "Store Sync Bot"
          git config user.email "bot@yourstore.com"

      - name: Merge Dev into Stage (excluding JSON files)
        run: |
          # Fetch latest changes
          git fetch origin

          # Switch to store-stage branch
          git checkout store-stage

          # Merge store-dev into store-stage
          git merge origin/store-dev --no-commit --no-ff || true

          # Revert all JSON files to store-stage's version (keep stage's JSON unchanged)
          git checkout origin/store-stage -- '*.json' 2>/dev/null || echo "No root JSON files"
          git checkout origin/store-stage -- '**/*.json' 2>/dev/null || echo "No nested JSON files"

          # Remove any new JSON files that don't exist in store-stage
          git diff --name-only --diff-filter=A | grep '\.json$' | while read file; do
            git rm "$file" 2>/dev/null || true
          done

          # Stage all changes
          git add -A

          # Complete the merge
          if ! git diff --cached --quiet; then
            git commit -m "Manual merge: store-dev to store-stage (code only, excluding JSON)"
            git push origin store-stage
          else
            echo "‚ÑπÔ∏è  No changes to commit after excluding JSON files"
          fi

  check-and-ignore-json:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Git Identity
        run: |
          git config user.name "Store Sync Bot"
          git config user.email "bot@yourstore.com"

      - name: Check for JSON Changes
        id: check_json
        run: |
          # Get list of changed JSON files in this PR
          JSON_FILES=$(git diff --name-only origin/store-stage...HEAD | grep '\.json$' || true)

          if [ -z "$JSON_FILES" ]; then
            echo "No JSON files changed in this PR ‚úì"
            echo "has_json_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Found JSON file changes:"
            echo "$JSON_FILES"
            echo "has_json_changes=true" >> $GITHUB_OUTPUT
            echo "json_files<<EOF" >> $GITHUB_OUTPUT
            echo "$JSON_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Merge PR excluding JSON files
        if: github.event.pull_request.base.ref == 'store-stage' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          # Fetch latest changes
          git fetch origin

          # Switch to store-stage branch
          git checkout origin/store-stage

          # Get the PR branch
          git fetch origin ${{ github.event.pull_request.head.ref }}

          # Create a custom merge that excludes JSON files
          # First, get all changed files except JSON
          NON_JSON_FILES=$(git diff --name-only origin/store-stage...origin/${{ github.event.pull_request.head.ref }} | grep -v '\.json$' || true)

          if [ -z "$NON_JSON_FILES" ]; then
            echo "‚ö†Ô∏è  No non-JSON files to merge"
            exit 0
          fi

          # Perform the merge
          git merge origin/${{ github.event.pull_request.head.ref }} --no-commit --no-ff || true

          # Revert all JSON files back to store-stage version
          git checkout origin/store-stage -- '*.json' 2>/dev/null || true
          git checkout origin/store-stage -- '**/*.json' 2>/dev/null || true

          # Remove any JSON files that don't exist in store-stage (new JSON files)
          git diff --name-only --diff-filter=A origin/store-stage...HEAD | grep '\.json$' | while read file; do
            git rm "$file" 2>/dev/null || true
          done

          # Stage the merge
          git add -A

          # Complete the merge
          if ! git diff --cached --quiet; then
            git commit -m "Merge PR #${{ github.event.pull_request.number }}: Code changes only (JSON files excluded)"
            git push origin store-stage
          else
            echo "‚ÑπÔ∏è  No changes to commit after excluding JSON files"
          fi

      - name: Add Info Comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            let body = '‚úÖ **Auto-Merge Status**\n\n';
            
            if ('${{ steps.check_json.outputs.has_json_changes }}' === 'true') {
              body += 'üîí **JSON Files Excluded from Merge**\n\nThe following JSON files were NOT merged (kept in store-stage):\n\n```\n${{ steps.check_json.outputs.json_files }}\n```\n\n';
            } else {
              body += '‚ú® No JSON files in this PR.\n\n';
            }
            
            body += '‚úîÔ∏è Only code/non-JSON changes have been merged into `store-stage`.\n\n*This is automatic protection to prevent Shopify config/template changes from affecting the stage store.*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })