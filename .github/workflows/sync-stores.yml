name: Auto-Sync Dev to Stage
on:
  push:
    branches:
      - store-dev  # Runs whenever you push to dev

jobs:
  merge-to-stage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for merging
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Git Identity
        run: |
          git config user.name "Store Sync Bot"
          git config user.email "bot@yourstore.com"

      - name: Merge Dev into Stage (excluding JSON files)
        run: |
          # 1. Switch to Stage
          git checkout store-stage

          # 2. Merge Dev into Stage
          git merge origin/store-dev --no-commit --no-ff || true

          # 3. Reset all JSON files to Stage's version (keep Stage's JSON unchanged)
          git checkout HEAD -- '*.json'
          git checkout HEAD -- '**/*.json'

          # 4. Complete the merge
          git commit -m "Automated Sync: Merging Dev into Stage (excluding JSON files)" || echo "Nothing to commit"

          # 5. Push back to GitHub
          git push origin store-stage