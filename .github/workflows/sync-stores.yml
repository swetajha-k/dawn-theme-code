name: Create PR from Dev to Stage
on:
  push:
    branches:
      - store-dev  # Runs whenever you push to dev

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Git Identity
        run: |
          git config user.name "Store Sync Bot"
          git config user.email "bot@yourstore.com"

      - name: Create Sync Branch (excluding JSON files)
        run: |
          # Fetch all branches
          git fetch origin

          # Create a unique branch name for the sync
          SYNC_BRANCH="sync-dev-to-stage-$(date +%Y%m%d-%H%M%S)"

          # Start from store-dev
          git checkout store-dev

          # Create new sync branch
          git checkout -b $SYNC_BRANCH

          # Reset JSON files to match store-stage version (exclude JSON from sync)
          git fetch origin store-stage:store-stage
          git checkout store-stage -- '*.json' '**/*.json' || echo "No JSON files to reset"

          # Commit the changes if there are any
          if git diff --cached --quiet; then
            echo "No changes to commit (excluding JSON)"
            echo "SKIP_PR=true" >> $GITHUB_ENV
          else
            git commit -m "Sync from store-dev to store-stage (excluding JSON files)" || echo "Nothing to commit"
            git push origin $SYNC_BRANCH
            echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV
            echo "SKIP_PR=false" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.SKIP_PR != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base store-stage \
            --head ${{ env.SYNC_BRANCH }} \
            --title "Sync from Dev to Stage (code only, no JSON)" \
            --body "This PR syncs code changes from \`store-dev\` to \`store-stage\`.<br><br>**Note:** JSON files are excluded from this sync and will not be merged."